<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>The ultimate task estimator - jRna examples</title>
    <script lang="javascript" src="3rd-party/jquery.js"></script>
    <script lang="javascript" src="../lib/jRna.js"></script>
    <script lang="javascript" id="description">
        const descr = {"title":"The ultimate task estimator - jRna examples"}
    </script>
    <script lang="javascript">
        window.onerror = function(msg) {
            document.getElementById("error").innerHTML += '<div>'+msg+'</div>';
        };
    </script>
    <style>
        .indent {
            padding-left: 1em;
            border-left: blue 1px solid;
        }
    </style>
</head>
<body>
    <div id="error" style="color: red"></div>
    <h1>The ultimate task estimator - jRna examples</h1>

    <!-- initial node to attach to -->
    <div id="root">
        <a href="#download" class="jrna-download">Download</a>
    </div>

    <div id="library" style="display: none">
        <div class="task">
            <div class="header jrna-header">
                <tt><a href="#" class="jrna-toggle">[-]</a></tt>
                <span class="jrna-total">...</span>
                <span class="jrna-title"></span>
                <a href="#" class="jrna-edit">[edit]</a>
                <input type="checkbox" class="jrna-split">
                <input size="3" class="jrna-hours hours">
            </div>
            <div class="indent jrna-content">
                <div class="jrna-children">
                </div>
                <div>
                    <a class="jrna-add" href="#">add subtask...</a>
                </div>
            </div>
        </div>

        <div class="editor">
            <input class="jrna-value">
            <a href="#save" class="jrna-save">save</a>
            <a href="#dismiss" class="jrna-dismiss">[x]</a>
        </div>
    </div>

    <!-- the script is here -->
    <script lang="javascript" id="main">
        "use strict";

        const editor = new jRna()
            .htmlFrom('#library .editor')
            .args( 'callback', 'value', 'size' )
            .input( 'value' )
            .def( 'save', function() {
                this.callback( this.value );
                this.remove(); 
            })
            .click('save', function() {
                this.save();
            })
            .click('dismiss', function() {
                this.remove();
            })
            .on('value', 'keypress', function(ev) {
                if (ev.key == "Enter") {
                    ev.preventDefault();
                    this.save();
                };
            })
            .onAttach( function () {
                if (typeof this.callback != 'function')
                    throw "Oops, callback required";
            });
    </script>
    <script>
        'use strict';
        const node = new jRna()
            .htmlFrom( '#library .task' )
            .args( 'title', 'parent' )
            .init( 'children', () => new Set() )
            .def( 'asJson', function() {
                const children = [];
                this.children.forEach( x => children.push( x.asJson() ) );
                return {
                    title: this.title,
                    children
                };
            })
            .output( 'title' )
            .element( 'header' )
            .element( 'content' )
            .element( 'children', 'box' )
            .click( 'edit', function() {
                editor.appendTo( this.header, {
                    value: this.title,
                    callback: (text => {
                        this.title = text;
                    }).bind(this)
                });
            })
            .output( 'toggle' )
            .toggle( 'toggle', function() {
                this.content.hide();
                this.toggle = '[+]';
            }, function() {
                this.content.show();
                this.toggle = '[-]';
            })
            .onRemove( function() {
                if (this.parent)
                    this.parent.children.delete(this);
            });

            node.stickyClick( 'add', 'addLock', function () {
                editor.appendTo( this.box, {
                    callback: ( text => {
                        // recurse!
                        const added = node.appendTo( this.box, {
                            parent: this,
                            title: text
                        });
                        this.children.add(added);
                        this.addLock = false;
                    }).bind(this)
                });
            } );

            const root = node.appendTo( '#root' );
    </script>
    <script>
        'use strict';
        const manage = new jRna()
            .download('download', () => JSON.stringify( root.asJson() ) )
            .attach( '#root' );
    </script>

    <!-- describe how to use the page, if needed -->
    <div id="usage">
    </div>
</body>
</html>
