<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>The ultimate task estimator - jRna examples</title>
    <script lang="javascript" src="3rd-party/jquery.js"></script>
    <script lang="javascript" src="../lib/jRna.js"></script>
    <script lang="javascript" id="description">
        const descr = {"title":"The ultimate task estimator - jRna examples"}
    </script>
    <script lang="javascript">
        window.onerror = function(msg) {
            document.getElementById("error").innerHTML += '<div>'+msg+'</div>';
        };
    </script>
    <style>
        .indent {
            padding-left: 1em;
            border-left: blue 1px solid;
        }
        .jrna-title {
            font-weight: bold;
            font-size: 110%;
            color: green;
        }
        .control {
            text-decoration: none;
            color: grey;
        }
    </style>
</head>
<body>
    <div id="error" style="color: red"></div>
    <h1>The ultimate task estimator - jRna examples</h1>

    <!-- initial node to attach to -->
    <div id="root">
        <a href="#download" class="jrna-download">Download</a>
        <input type="file" class="jrna-upload">
    </div>

    <div id="library" style="display: none">
        <div class="task">
            <div class="header jrna-header">
                <a href="#" class="control jrna-toggle">[-]</a>
                <span class="jrna-hours">...</span>
                <span class="jrna-title"></span>
                <a href="#" class="control jrna-edit">[edit]</a>
                <a href="#" class="control jrna-estimate">[estimate]</a>
                <a href="#" class="control jrna-split">[split]</a>
            </div>
            <div class="indent jrna-content">
                <div class="jrna-children">
                </div>
                <div>
                    <a class="control jrna-add" href="#">[add subtask...]</a>
                </div>
            </div>
        </div>

        <div class="editor">
            <input class="jrna-value">
            <a href="#save" class="control jrna-save">[save]</a>
            <a href="#dismiss" class="control jrna-dismiss">[x]</a>
        </div>
    </div>

    <!-- the script is here -->
    <script lang="javascript" id="main">
        "use strict";

        const editor = new jRna()
            .htmlFrom('#library .editor')
            .args( 'onSave', 'onClose', 'value', 'size' )
            .input( 'value' )
            .def( 'save', function() {
                this.onSave( this.value );
                this.remove(); 
            })
            .click('save', function() {
                this.save();
            })
            .click('dismiss', function() {
                this.remove();
            })
            .on('value', 'keypress', function(ev) {
                if (ev.key == "Enter") {
                    ev.preventDefault();
                    this.save();
                };
            })
            .onAttach( function () {
                if (typeof this.onSave != 'function')
                    throw 'onSave must be a function';
                if (this.onClose && typeof this.onClose != 'function')
                    throw 'onClose must be a function, if present';
            })
            .onRemove( function() {
                if (this.onClose)
                    this.onClose();
            });
    </script>
    <script>
        'use strict';
        const node = new jRna()
            .htmlFrom( '#library .task' )
            .args( 'title', 'parent', 'children' )
            .init( 'childrenSet', () => new Set() )
            .def( 'asJson', function() {
                const children = [];
                this.childrenSet.forEach( x => children.push( x.asJson() ) );
                return {
                    title: this.title,
                    children
                };
            })
            .output( 'hours' )
            .output( 'title' )
            .element( 'header' )
            .element( 'content' )
            .element( 'children', 'childrenBox' )
            .stickyClick( 'edit', 'editLock', function() {
                const me = this;
                editor.appendTo( this.header, {
                    value: me.title,
                    onSave: text => {
                        me.title = text;
                    },
                    onClose: () => { me.editLock = false; }
                });
            })
            .element( 'toggle' )
            .output( 'toggle', 'toggleLabel' )
            .toggle( 'toggle', function() {
                this.content.hide();
                this.toggleLabel = '[+]';
            }, function() {
                this.content.show();
                this.toggleLabel = '[-]';
            })
            .stickyState( 'isSplit', {
                true: function() {
                    this.toggle.show();
                    this.content.show();
                },
                false: function() {
                    this.toggle.hide();
                    this.content.hide();
                }
            })
            .stickyClick( 'estimate', 'editLock', function() {
                const me = this;
                editor.appendTo( this.header, {
                    size: 3,
                    value: me.hours,
                    onSave: function (nnn) {
                        // TODO check value
                        me.hours = nnn;
                        me.isSplit(false);
                    },
                    onClose: () => { me.editLock = false; }
                });
            })
            .stickyClick( 'split', 'editLock', function() {
                this.editLock = false; // free lock immediately
                this.isSplit(true);
            })
            .onAttach( function() {
                if (this.children) {
                    for (let child of this.children)
                        this.addChild(child);
                };
            })
            .onRemove( function() {
                if (this.parent)
                    this.parent.childrenSet.delete(this);
            });

            node.def( 'addChild', function(input) {
                const added = node.appendTo( this.childrenBox, {
                    parent   : this,
                    title    : input.title,
                    children : input.children
                });
                this.childrenSet.add(added);
            });

            node.stickyClick( 'add', 'editLock', function () {
                const me = this;
                editor.appendTo( this.childrenBox, {
                    onSave: text => {
                        me.addChild( { title: text } );
                    },
                    onClose: () => { me.editLock = false; }
                });
            } );

            let root = node.appendTo( '#root' );
    </script>
    <script>
        'use strict';
        const manage = new jRna()
            .download('download', () => JSON.stringify( root.asJson() ) )
            .upload( 'upload' )
            .on( 'upload', 'change', function() {
                this.upload( result => {
                    const newroot = node.spawn(JSON.parse(result.content));
                    root.remove();
                    root = newroot.appendTo('#root');
                } );
            })
            .attach( '#root' );
    </script>

    <!-- describe how to use the page, if needed -->
    <div id="usage">
    </div>
</body>
</html>
